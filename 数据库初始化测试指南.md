# 数据库初始化测试指南

## 📋 步骤一：部署云函数

### 1. 使用一键部署脚本
```bash
# 双击运行
部署云函数.bat
```

### 2. 手动部署（备选方案）
1. 打开微信开发者工具
2. 右键点击 `cloudfunctions` 文件夹
3. 选择 "上传并部署：云端安装依赖"
4. 等待部署完成

## 📋 步骤二：初始化数据库

### 1. 在微信开发者工具中测试云函数
1. 右键点击 `cloudfunctions/initDatabase` 文件夹
2. 选择 "在云端控制台中查看"
3. 点击 "测试" 标签页
4. 点击 "调用" 按钮
5. 查看执行结果

### 2. 预期结果
```json
{
  "success": true,
  "message": "数据库初始化完成",
  "collections": [
    "visitors"
  ]
}
```

## 📋 步骤三：测试手机号获取功能

### 1. 测试 getPhoneNumber 云函数
在云端控制台中测试，使用以下参数：
```json
{
  "code": "test_code_123"
}
```

### 2. 预期结果（权限未配置时）
```json
{
  "success": false,
  "message": "手机号获取权限未配置，请联系管理员配置权限",
  "errCode": -604100
}
```

### 3. 这是正常的！
- 错误码 `-604100` 表示权限未配置
- 小程序会自动降级到手动输入模式
- 用户可以正常完成登记

## 📋 步骤四：端到端测试

### 1. 在模拟器中测试完整流程
1. 点击 "一键登记" 按钮
2. 授权头像昵称信息
3. 授权手机号（会失败，这是正常的）
4. 在弹出的对话框中手动输入手机号
5. 点击确认完成登记

### 2. 检查数据库
1. 打开云开发控制台
2. 进入数据库管理
3. 查看 `visitors` 集合
4. 确认访客数据已保存

## 🔧 故障排除

### 云函数部署失败
- 检查网络连接
- 确认微信开发者工具版本
- 重试部署操作

### 数据库初始化失败
- 检查云开发环境是否开通
- 确认环境ID配置正确
- 查看云函数执行日志

### 手机号获取一直失败
- 这是预期行为（权限未配置）
- 确认手动输入功能正常工作
- 如需自动获取，按照权限配置指南操作

## ✅ 成功标志

完成以下检查项表示部署成功：
- [ ] 所有云函数部署无错误
- [ ] initDatabase 执行成功
- [ ] getPhoneNumber 返回 -604100 错误（正常）
- [ ] 小程序可以完成完整登记流程（使用手动输入）
- [ ] 访客数据成功保存到数据库

## 📞 支持

如遇到问题，请查看以下文档：
- `当前状态说明.md` - 了解当前状况
- `云函数权限配置指南.md` - 配置自动获取权限
- `API修正说明.md` - 了解API修正详情
