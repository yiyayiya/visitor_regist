# 云函数权限配置详细指南

## 错误分析
错误码 `-604100 API not found` 表示云函数缺少获取手机号的API权限。

## 解决步骤

### 步骤1：打开微信开发者工具
1. 确保项目已连接到云开发环境
2. 点击工具栏中的"云开发"按钮

### 步骤2：进入云函数管理
1. 在云开发控制台中，点击左侧菜单"云函数"
2. 找到 `getPhoneNumber` 函数

### 步骤3：配置API权限
1. 点击 `getPhoneNumber` 函数名称
2. 进入函数详情页面
3. 点击"权限管理"选项卡
4. 在"微信API权限"部分，找到并开通以下权限：
   - ✅ `openapi.phonenumber.getuserphonenumber` - 获取手机号权限

### 步骤4：重新部署云函数
权限配置完成后，需要重新部署云函数：
1. 在微信开发者工具中右键点击 `cloudfunctions/getPhoneNumber`
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 步骤5：验证权限配置
在云开发控制台中：
1. 进入"云函数" -> "getPhoneNumber"
2. 点击"权限管理"
3. 确认 `openapi.phonenumber.getuserphonenumber` 权限状态为"已开通"

## 权限配置截图指引

### 位置1：云开发控制台入口
```
微信开发者工具 -> 工具栏 -> 云开发
```

### 位置2：云函数管理
```
云开发控制台 -> 左侧菜单 -> 云函数 -> getPhoneNumber
```

### 位置3：权限管理
```
getPhoneNumber函数详情 -> 权限管理 -> 微信API权限
```

### 位置4：开通权限
```
找到: openapi.phonenumber.getuserphonenumber
点击: 申请开通 或 开通
```

## 常见问题

### Q1: 找不到权限管理选项卡
**A:** 确保云函数已正确部署，只有部署成功的云函数才会显示权限管理选项。

### Q2: 权限申请被拒绝
**A:** 确保小程序已完成认证，未认证的小程序无法使用获取手机号功能。

### Q3: 权限开通后仍然报错
**A:** 权限开通后需要重新部署云函数，等待5-10分钟生效。

### Q4: 无法找到 openapi.phonenumber.getuserphonenumber 权限
**A:** 确保：
- 小程序已认证
- 云开发环境已正确初始化
- 使用的是正式环境而非测试环境

## 验证权限是否生效

可以在云开发控制台中测试云函数：
1. 进入 getPhoneNumber 函数详情
2. 点击"测试"选项卡
3. 输入测试参数：
```json
{
  "code": "test_code"
}
```
4. 点击"运行测试"
5. 如果权限正确，应该看到相应的错误信息而不是 -604100

## 小程序认证要求

获取手机号功能要求：
- ✅ 小程序必须已通过微信认证
- ✅ 小程序类型为非个人主体
- ✅ 具备相应的业务资质

如果是个人开发者或未认证小程序，建议：
- 跳过手机号获取，使用其他方式收集联系信息
- 或者申请企业认证后再使用此功能

## 替代方案

如果无法开通手机号权限，可以考虑：
1. 使用文本输入框让用户手动输入手机号
2. 集成第三方手机验证服务
3. 使用其他联系方式（如微信号）

## 测试建议

权限配置完成后，建议：
1. 先在云开发控制台测试云函数
2. 再在小程序中进行端到端测试
3. 使用真机测试，避免开发者工具限制
