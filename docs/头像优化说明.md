# 头像存储优化说明

## 问题背景

微信小程序中直接保存的 `avatarUrl` 存在以下问题：
1. **有效期限制**：微信头像URL有时效性，过期后无法访问
2. **访问权限**：其他用户可能无法访问临时文件路径
3. **不稳定性**：`wxfile://` 和 `http://tmp/` 类型的URL不适合长期存储

## 解决方案

### 1. 新增云函数

#### uploadAvatar 云函数
- **功能**：下载用户头像并上传到自己的云存储
- **支持格式**：
  - `https://` 开头的网络图片
  - `wxfile://` 开头的微信临时文件
  - `http://tmp/` 开头的临时文件
- **输出**：返回云存储的永久访问URL

#### migrateAvatars 云函数
- **功能**：批量处理现有数据中的头像URL
- **特点**：每次处理10条记录，避免超时
- **用途**：处理历史数据的头像迁移

### 2. 优化流程

#### 新用户注册流程：
1. 用户选择头像 → 获取临时URL
2. 调用 `saveVisitor` 云函数
3. 自动调用 `uploadAvatar` 处理头像
4. 保存云存储URL到数据库

#### 现有数据迁移：
1. 在管理员后台点击头像迁移按钮（📁图标）
2. 批量处理现有访客头像
3. 更新数据库中的头像URL

### 3. 部署步骤

#### 步骤1：部署云函数
```bash
# 运行部署脚本
./部署云函数.bat

# 或在微信开发者工具中：
# 1. 右键 cloudfunctions/uploadAvatar → 上传并部署：云端安装依赖
# 2. 右键 cloudfunctions/migrateAvatars → 上传并部署：云端安装依赖
# 3. 右键 cloudfunctions/saveVisitor → 上传并部署：云端安装依赖
```

#### 步骤2：权限配置
确保云函数具有以下权限：
- `uploadAvatar`：云存储读写权限
- `migrateAvatars`：调用其他云函数权限
- `saveVisitor`：调用其他云函数权限

### 4. 使用说明

#### 管理员操作：
1. 进入访客列表管理页面
2. 点击右侧的头像迁移按钮（📁图标）
3. 确认迁移操作
4. 等待批量迁移完成

#### 自动处理：
- 新用户注册时自动处理头像
- 头像加载失败时自动使用默认头像
- 支持头像URL格式验证

### 5. 技术细节

#### 头像存储路径：
```
云存储路径：avatars/{openid}_{timestamp}.{ext}
示例：avatars/oWiIF7tWh_1733664000000.jpg
```

#### 错误处理：
- 网络超时：10秒超时设置
- 下载失败：保留原始URL，不阻断流程
- 格式不支持：返回错误信息

#### 数据库字段：
```javascript
{
  avatarUrl: "cloud://xxx.jpg",        // 新的云存储URL
  originalAvatarUrl: "wxfile://xxx",   // 原始URL（用于调试）
  migratedAt: "2025-06-08T10:30:00Z"   // 迁移时间
}
```

### 6. 监控和维护

#### 检查迁移状态：
可以通过数据库查询检查哪些头像还需要迁移：
```javascript
// 查询未迁移的头像
db.collection('visitors').where({
  avatarUrl: db.RegExp({
    regexp: '^(?!cloud://)',
    options: 'i'
  })
}).get()
```

#### 清理临时文件：
云存储会自动管理文件，无需手动清理。

## 注意事项

1. **分批处理**：避免一次性处理过多数据导致超时
2. **错误容忍**：单个头像处理失败不影响整体流程
3. **成本考虑**：云存储按使用量计费，注意控制成本
4. **备份策略**：重要数据建议定期备份

## 部署验证

部署完成后，可以通过以下方式验证：

1. **新用户测试**：注册新用户，检查头像是否正确保存
2. **迁移测试**：运行头像迁移，检查现有数据是否更新
3. **访问测试**：确认头像URL能正常显示图片
4. **错误测试**：测试各种异常情况的处理

## 问题排查

如遇问题，请检查：
1. 云函数部署状态
2. 云存储权限配置
3. 网络连接状况
4. 控制台错误日志
