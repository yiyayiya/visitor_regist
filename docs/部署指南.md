# 微信小程序访客登记系统 - 云函数部署指南

## 📋 部署前准备

### 1. 环境要求
- 微信开发者工具（最新版本）
- Node.js 环境
- 已开通云开发服务的小程序

### 2. 云存储配置
确保您的云开发环境已开通云存储服务，用于存储用户头像。

## 🚀 快速部署

### 方法一：使用自动化脚本（推荐）

1. 在项目根目录下，双击运行 `部署云函数.bat`
2. 等待所有依赖安装完成
3. 在微信开发者工具中逐个上传云函数

### 方法二：手动部署

1. 在微信开发者工具中，依次右键以下云函数目录并选择"上传并部署"：
   - `getPhoneNumber` - 获取手机号
   - `saveVisitor` - 保存访客信息（已包含头像优化）
   - `initDatabase` - 初始化数据库
   - `getVisitors` - 获取访客列表
   - `uploadAvatar` - 头像上传优化（新增）

## 📁 云函数说明

| 云函数名 | 功能描述 | 新增/修改 |
|---------|----------|----------|
| `getPhoneNumber` | 获取用户手机号 | 无变化 |
| `saveVisitor` | 保存访客信息 | ✅ 已修改 - 集成头像优化 |
| `initDatabase` | 初始化数据库结构 | 无变化 |
| `getVisitors` | 获取访客列表 | 无变化 |
| `uploadAvatar` | 头像上传优化 | ✅ 新增 |

## 🔧 云函数权限配置

### uploadAvatar 云函数权限
确保 `uploadAvatar` 云函数具有以下权限：
- 云存储读写权限
- 网络请求权限

### saveVisitor 云函数权限  
确保 `saveVisitor` 云函数具有以下权限：
- 数据库读写权限
- 调用其他云函数权限（用于调用 uploadAvatar）

## ✨ 功能特性

### 头像优化功能
- **自动处理**：新用户注册时自动优化头像
- **多格式支持**：支持 https、wxfile://、http://tmp/ 等格式
- **永久存储**：将临时头像上传到云存储获得永久链接
- **错误处理**：头像加载失败时自动使用默认头像
- **向下兼容**：不影响现有用户数据

### 数据库字段更新
新用户数据将包含：
- `avatarUrl` - 云存储永久链接（主要使用）
- `originalAvatarUrl` - 原始临时链接（调试用）

## 🧪 测试建议

1. **新用户注册测试**：
   - 使用新微信号注册访客
   - 检查头像是否正常显示
   - 确认头像URL为云存储地址

2. **异常处理测试**：
   - 断网情况下查看头像显示
   - 检查默认头像是否正常加载

3. **性能测试**：
   - 批量用户注册
   - 访客列表加载速度
   - 头像加载响应时间

## 📞 技术支持

如果在部署过程中遇到问题，请检查：
1. 云开发环境是否正常
2. 云函数权限配置是否正确
3. 网络连接是否稳定
4. 微信开发者工具版本是否最新

---

**注意**：头像优化功能仅对新注册用户生效，现有用户数据保持不变。如需要批量迁移现有用户头像，可联系技术支持获取专门的迁移方案。
