# 微信小程序云开发集成说明

## 概述
本项目已集成微信小程序云开发，实现了以下功能：
- 云函数获取用户手机号
- 云数据库存储访客信息
- 云函数查询访客列表

## 云开发环境配置

### 1. 开通云开发环境
1. 登录微信开发者工具
2. 进入小程序项目
3. 点击"云开发"按钮
4. 创建云环境（免费版每月有一定额度）
5. 记录环境ID（env-xxxxx）

### 2. 修改环境配置
在 `app.js` 中修改云环境ID：
```javascript
wx.cloud.init({
  env: 'your-env-id', // 替换为你的云环境ID
  traceUser: true,
})
```

## 云函数部署

### 1. 上传并部署云函数

#### getPhoneNumber 函数
```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/getPhoneNumber
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

#### saveVisitor 函数
```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/saveVisitor
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

#### getVisitors 函数
```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/getVisitors
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

### 2. 云函数权限配置
确保云函数有以下权限：
- `openapi.phonenumber.getuserphonenumber`：获取手机号权限
- 数据库读写权限

## 数据库集合

### visitors 集合
存储访客信息，字段包括：
- `_id`：自动生成的唯一标识
- `openid`：用户微信唯一标识
- `appid`：小程序AppID
- `avatarUrl`：用户头像URL
- `nickName`：用户昵称
- `phoneNumber`：用户手机号
- `communityName`：小区名称
- `areaName`：区域名称
- `cityName`：城市名称
- `registerTime`：登记时间
- `_createTime`：创建时间（服务器时间）

### 数据库权限设置
建议设置以下权限：
- 仅创建者可读写：确保数据安全
- 或者自定义权限：管理员可读写，普通用户只能创建

## 功能说明

### 1. 访客登记流程
1. 用户扫码进入小程序
2. 点击"一键登记"
3. 授权获取头像和昵称（`wx.getUserProfile`）
4. 授权获取手机号（`button open-type="getPhoneNumber"`）
5. 调用云函数 `getPhoneNumber` 解析手机号
6. 调用云函数 `saveVisitor` 保存到云数据库
7. 显示登记结果

### 2. 管理员查看访客
1. 管理员登录
2. 进入访客列表页面
3. 调用云函数 `getVisitors` 从云数据库获取数据
4. 支持按小区名称筛选
5. 支持下拉刷新

## 错误处理

### 常见问题及解决方案

1. **云函数调用失败**
   - 检查环境ID是否正确
   - 确认云函数已正确部署
   - 查看调试器网络面板的错误信息

2. **获取手机号失败**
   - 确认小程序已认证
   - 检查云函数权限配置
   - 确认用户已授权

3. **数据库操作失败**
   - 检查数据库权限设置
   - 确认数据格式正确
   - 查看云函数日志

## 监控与调试

### 1. 云函数日志
在微信开发者工具的云开发面板中查看：
- 云函数调用日志
- 错误信息
- 性能统计

### 2. 数据库管理
在云开发控制台中可以：
- 查看数据库记录
- 执行查询操作
- 设置索引优化性能

### 3. 统计分析
云开发提供：
- 调用量统计
- 错误率分析
- 性能监控

## 费用说明

### 免费额度（按月）
- 云函数调用：100万次
- 数据库读操作：5万次
- 数据库写操作：3万次
- 存储空间：2GB
- CDN流量：5GB

### 计费规则
超出免费额度后按实际使用量计费，费用较低。

## 安全建议

1. **数据库权限**：设置合理的读写权限
2. **敏感数据**：手机号等敏感信息要谨慎处理
3. **API调用**：避免恶意调用，可以设置频率限制
4. **数据备份**：定期导出重要数据

## 扩展功能

可以继续添加：
1. **访客签出功能**：记录离开时间
2. **短信通知**：通知相关人员
3. **数据导出**：Excel格式导出
4. **统计报表**：访客数量统计
5. **二维码管理**：动态生成小区二维码

## 部署检查清单

- [ ] 云环境已创建并获取环境ID
- [ ] app.js中环境ID已配置
- [ ] getPhoneNumber云函数已部署
- [ ] saveVisitor云函数已部署  
- [ ] getVisitors云函数已部署
- [ ] 数据库权限已设置
- [ ] 小程序已发布到体验版进行测试
- [ ] 功能测试通过
