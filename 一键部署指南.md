# 🚀 一键部署脚本指南

## 📋 当前需要解决的问题

根据你的测试日志：
1. ✅ 手机号授权成功（获取到了code）
2. ❌ 云函数处理失败（返回success: false）
3. ❌ 数据库集合不存在（-502005错误）

## 🎯 立即执行的3个关键步骤

### 步骤1：部署修正后的getPhoneNumber云函数
```
在微信开发者工具中：
1. 右键点击 cloudfunctions/getPhoneNumber
2. 选择"上传并部署：云端安装依赖"
3. 等待显示"上传成功"
```

### 步骤2：部署并执行数据库初始化
```
1. 右键点击 cloudfunctions/initDatabase
2. 选择"上传并部署：云端安装依赖"
3. 部署完成后，点击云开发控制台
4. 进入"云函数" → "initDatabase"
5. 点击"测试"选项卡
6. 点击"运行测试"按钮
7. 确认返回成功信息
```

### 步骤3：部署saveVisitor云函数
```
1. 右键点击 cloudfunctions/saveVisitor  
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

## ⚡ 快速验证清单

部署完成后，进行以下验证：

### ✅ 云函数状态检查
```
云开发控制台 → 云函数
确认以下函数状态为"正常"：
- getPhoneNumber
- initDatabase  
- saveVisitor
```

### ✅ 数据库集合检查
```
云开发控制台 → 数据库
确认存在集合：
- visitors（应该已自动创建）
```

### ✅ 真机重新测试
```
1. 重新预览小程序
2. 手机扫码进入
3. 测试完整流程
4. 观察控制台日志
```

## 🔍 预期的成功日志

### getPhoneNumber云函数日志：
```javascript
开始调用微信API，code: ac85c2f9e106535f...
微信API完整返回结果： {
  "errcode": 0,  // 或 -604100（权限问题）
  "errmsg": "ok",
  "phone_info": {
    "phoneNumber": "138****8888"
  }
}
```

### initDatabase云函数日志：
```javascript
visitors 集合创建成功
数据库初始化完成
```

### saveVisitor云函数日志：
```javascript
访客信息保存成功： { _id: "xxx", ... }
```

## 🎯 根据测试结果的处理方案

### 场景A：手机号API权限错误（-604100）
```
解决方案：
1. 按照《API权限完整配置指南.md》配置权限
2. 或者使用手动输入（程序已支持）
```

### 场景B：手机号API调用成功
```
结果：功能完全正常，可以投入使用
```

### 场景C：其他错误
```
操作：提供具体错误日志，进行针对性分析
```

## 🔥 重要提醒

1. **必须使用真机测试**：模拟器无法测试手机号获取
2. **必须先初始化数据库**：否则数据保存会失败
3. **现在强制要求手机号**：用户必须提供手机号才能完成登记

## 📞 执行后反馈

请完成3个步骤后告诉我：
1. 云函数部署是否全部成功？
2. 数据库初始化是否成功？
3. 真机测试的具体日志结果？

这样我可以根据实际情况提供下一步指导。
