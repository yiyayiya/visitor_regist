# 问题修复指南

## 当前遇到的问题及解决方案

### 1. ❌ 无效的 app.json permission["scope.userInfo"]
**问题原因：** `scope.userInfo` 权限已废弃，新版本微信小程序不再支持此权限配置。

**解决方案：** 
- ✅ 已删除无效的 permission 配置
- ✅ 添加了 requiredPrivateInfos 配置

### 2. ❌ invoke wx.getUserProfile too frequently
**问题原因：** 频繁调用 `wx.getUserProfile` 触发了微信的调用限制。

**解决方案：**
- ✅ 添加了防抖机制，避免重复调用
- ✅ 缓存用户信息，避免重复获取
- ✅ 添加调用状态标记

### 3. ❌ 云函数调用失败 (API not found -604100)
**问题原因：** 云函数权限不足或未正确配置获取手机号权限。

**解决方案：**
1. **检查云函数权限：**
   ```bash
   # 在微信开发者工具云开发控制台中
   1. 进入云函数管理
   2. 找到 getPhoneNumber 函数
   3. 点击权限管理
   4. 确保已开通 "openapi.phonenumber.getuserphonenumber" 权限
   ```

2. **重新部署云函数：**
   ```bash
   # 在微信开发者工具中
   1. 右键点击 cloudfunctions/getPhoneNumber
   2. 选择"上传并部署：云端安装依赖"
   3. 等待部署完成
   ```

### 4. ❌ DATABASE_COLLECTION_NOT_EXIST
**问题原因：** 数据库集合 `visitors` 不存在。

**解决方案：**
1. **手动创建集合：**
   ```bash
   # 在微信开发者工具云开发控制台中
   1. 进入数据库管理
   2. 点击"添加集合"
   3. 输入集合名称：visitors
   4. 点击确定
   ```

2. **使用初始化云函数：**
   ```bash
   # 1. 部署 initDatabase 云函数
   右键点击 cloudfunctions/initDatabase -> 上传并部署
   
   # 2. 在云开发控制台中调用
   进入云函数管理 -> initDatabase -> 测试 -> 调用
   ```

3. **设置数据库权限：**
   ```json
   // 在数据库集合权限设置中
   {
     "read": true,
     "write": "auth.openid == resource.openid"
   }
   ```

## 部署步骤

### 1. 云环境配置
确保 `app.js` 中的环境ID正确：
```javascript
env: 'cloud1-0gfyo78sa7d3f1a5', // 替换为你的实际环境ID
```

### 2. 云函数部署顺序
```bash
1. initDatabase    # 先部署数据库初始化函数
2. getPhoneNumber  # 获取手机号函数
3. saveVisitor     # 保存访客信息函数
4. getVisitors     # 查询访客列表函数
```

### 3. 权限配置
在云开发控制台中配置以下权限：
- `openapi.phonenumber.getuserphonenumber`：获取手机号
- 数据库读写权限
- 云函数调用权限

### 4. 数据库初始化
```bash
# 调用初始化云函数
wx.cloud.callFunction({
  name: 'initDatabase'
})
```

## 测试步骤

### 1. 基础功能测试
```javascript
// 测试参数
pages/index/index?community_name=测试小区&area_name=测试区域&city_name=测试城市
```

### 2. 云函数测试
在云开发控制台中逐个测试云函数：
1. initDatabase - 初始化数据库
2. getPhoneNumber - 测试手机号获取
3. saveVisitor - 测试数据保存
4. getVisitors - 测试数据查询

### 3. 完整流程测试
1. 扫码进入小程序
2. 点击"一键登记"
3. 授权获取用户信息
4. 授权获取手机号
5. 查看登记结果

## 常见错误及解决

| 错误代码 | 错误信息 | 解决方案 |
|---------|---------|---------|
| -604100 | API not found | 检查云函数权限配置 |
| -502005 | Collection not exist | 创建 visitors 集合 |
| -502006 | Collection already exists | 集合已存在，正常 |
| 40001 | Invalid credential | 检查 AppID 和密钥 |

## 监控和调试

### 1. 查看云函数日志
```bash
# 在云开发控制台中
云函数管理 -> 选择函数 -> 日志 -> 查看调用记录
```

### 2. 查看数据库操作
```bash
# 在云开发控制台中
数据库 -> visitors 集合 -> 查看记录
```

### 3. 性能监控
```bash
# 在云开发控制台中
监控 -> 查看调用量、错误率、响应时间
```

## 注意事项

1. **小程序必须已认证** 才能使用获取手机号功能
2. **环境ID** 必须与云开发控制台中的环境ID一致
3. **权限配置** 需要在云开发控制台中正确设置
4. **测试时** 建议使用真机调试，模拟器可能有限制
5. **生产环境** 建议设置更严格的数据库权限
